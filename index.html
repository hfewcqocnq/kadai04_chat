<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>
<link rel="stylesheet" href="css/style.css">
</head>
<body>

<!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->

<div>
  <div class="name">
      åå‰ï¼š<input type="text" id="uname">
  </div>
  <div class="comment">ã‚³ãƒ¡ãƒ³ãƒˆï¼š<br>
      <textarea id="text" cols="30" rows="10"></textarea>
      <button id="send">é€ä¿¡</button>
  </div>
  <div id="output"></div>
</div>
<!--/ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->



<!-- JQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- JQuery -->


<!--** ä»¥ä¸‹Firebase **-->
<script type="module">
// firebaseApikey.jsã‹ã‚‰exportã•ã‚Œã¦ã„ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’firebaseConfigã¨ã„ã†å¤‰æ•°åã§å–ã‚Šæ‰±ã†ã¨ã„ã†æ„å‘³ã®è¨˜è¿°
import firebaseConfig from "./firebaseApikey.js";
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, push, set, update,remove, onChildAdded, onChildChanged,onChildRemoved } 
  // importã«æ›¸ã„ãŸé–¢æ•°ã—ã‹ä½¿ãˆãªã„
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
// keyç™ºè¡Œã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨åˆã‚ã›ã‚‹
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

console.log(firebaseConfig);

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã™ã‚‹ã‚ˆ
  const dbRef = ref(db,"chat");
  // ã©ã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’æµã™ã‹ï¼ˆãƒãƒ£ãƒƒãƒˆã¨ã„ã†éšå±¤ã«æµã™ï¼‰

  // é€ä¿¡
  $("#send").on("click",function(){
    const msg = {
      uname : $("#uname").val(),
      text : $("#text").val()
    }
    const newPostRef = push(dbRef);
    // ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã‚’ç”Ÿæˆï¼ˆéšå±¤ã®ä¸‹ã«è‡ªå‹•çš„ã«æŒ¯ã‚‰ã‚Œã‚‹é•·ã„åå‰ï¼‰
    // ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã«ã™ã‚‹ã“ã¨ã§ä¸Šæ›¸ãã•ã‚Œãšã«æ›´æ–°ã•ã‚Œã‚‹
    set(newPostRef,msg);
    //"ä½œæˆã—ãŸãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²

    // è‡ªåˆ†ã§æ±ºã‚ãŸéšå±¤ã«ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ãŸã„å ´åˆ
    // ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã®ç”Ÿæˆã¯ä¸è¦
    // set(dbRef,msg);
    // è‡ªèº«ã®æ±ºã‚ãŸéšå±¤ã¸ã®ç™»éŒ²ãŒã§ãã‚‹ï¼ˆãƒ¡ãƒ¢å¸³ã‚¢ãƒ—ãƒªãªã©ï¼‰
  });

    // æœ€åˆã«ãƒ‡ãƒ¼ã‚¿å–å¾—&onSnapshotã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ãƒ‡ãƒ¼ã‚¿å–å¾—
    onChildAdded(dbRef,function(data){
      // ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã‚‹ã¨è‡ªå‹•çš„ã«å–å¾—
      const msg = data.val();
      const key = data.key;
      // å‰Šé™¤ãƒ»æ›´æ–°ã«ã¯ã‚­ãƒ¼åãŒé‡è¦
      // å…¥ã£ã¦ããŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–ã‚Šå‡ºã™éš›ã«ä½¿ç”¨ï¼ˆä¸‹è¨˜ï¼‰
      let h = '<p id="'+key+'">';
        // ä¸€ã¤ã®æŠ•ç¨¿ãŒpã‚¿ã‚°ï¼ˆã‚­ãƒ¼åï¼‰ã«ã‚ˆã£ã¦ããã‚‰ã‚Œã¦ã„ã‚‹ã€å…¨å“¡å…±é€šã§å‰Šé™¤ã™ã‚‹ãŸã‚ã«å¿…è¦
          h += msg.uname;
          h += '<br>';
          h += '<span contentEditable="true" id="'+key+'_update">'+msg.text+'<?span>';
            // contentEditableã«ã‚ˆã£ã¦ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§æŠ•ç¨¿ã®å¤‰æ›´ãŒå¯èƒ½
          h += '<span class="remove" data-key="'+key+'">ğŸš®</span>'
          h += '<span class="update" data-key="'+key+'">ğŸ†™</span>'
          // updateãŒæŠ¼ã•ã‚ŒãŸã¨ãã«id="'+key+'_update"ã¨ã—ã¦ãŠãã“ã¨ã§æ›´æ–°ã•ã‚ŒãŸtextã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹
          h += '</p>';

          // ä¾‹ï¼š<p>ã‚<br>ã‚ã‚</p>ã®ã‚ˆã†ãªhtmlè¡¨ç¤ºã¨ãªã‚‹
          $("#output").prepend(h);
          // appendã§ä¸€ç•ªä¸‹ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¶³ã—ç¶šã‘ã‚‹
    });

    // "#output"ã¯æŠ•ç¨¿ã®é ˜åŸŸã®ã“ã¨
    // å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
    $("#output").on("click",".remove",function(){
      // removeãŒclickã•ã‚ŒãŸã‚‰å®Ÿè¡Œ
      const key = $(this).attr("data-key");
      // thisï¼clickã•ã‚ŒãŸç‰¹å®šã®"data-key"ã‚’å–å¾—
      const remove_item = ref(db,"chat/"+key);
      // å ´æ‰€ã‚’æŒ‡å®šï¼ˆãƒãƒ£ãƒƒãƒˆã®ä¸­ã®ç‰¹å®šãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ï¼‰
      remove(remove_item);
      // å‰Šé™¤ã‚’ã™ã‚‹
    });

    // æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
    $("#output").on("click",".update",function(){
      const key =$(this).attr("data-key");
      update(ref(db,"chat/"+key), {
      //  ã©ã“ã®ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ¼ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹ã‹
                  text: $("#"+key+'_update').html()
      // 88è¡Œç›®ã§å¤‰æ›´ã•ã‚ŒãŸã¨ã“ã‚ã®ã‚­ãƒ¼ã‚’ã‚‚ã¨ã«htmlã«åæ˜ 
      });
    });

    // å‰Šé™¤å‡¦ç†ãŒãƒ•ã‚¡ã‚¤ãƒ¤ãƒ¼ãƒ™ãƒ¼ã‚¹ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
    onChildRemoved(dbRef,(data) => {
    // onChildRemovedã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§å‰Šé™¤ã•ã‚ŒãŸã“ã¨ã‚’æ„ŸçŸ¥
      $("#"+data.key).remove();
      // Pã‚¿ã‚°ã®ä¸€ã¤ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã™ã‚‹
    });

    // æ›´æ–°å‡¦ç†ãŒãƒ•ã‚¡ã‚¤ã‚¢ãƒ¼ãƒ™ãƒ¼ã‚¹ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
    onChildChanged(dbRef,(data) => {
    // onChildChangedã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§æ›´æ–°ã•ã‚ŒãŸã“ã¨ã‚’æ„ŸçŸ¥
      $("#"+data.key+'_update').html(data.val().text);
      // 88è¡Œç›®ã§å¤‰æ›´ã•ã‚ŒãŸã¨ã“ã‚ã®ã‚­ãƒ¼ã‚’ã‚‚ã¨ã«data.val()ã®ä¸­ã®textã‚’htmlã«æ›´æ–°åæ˜ 
      $("#"+data.key+'_update').fadeOut(800).fadeIn(800);
    });
    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ãƒ»ã‚¢ã‚¦ãƒˆã§è©²å½“ç®‡æ‰€ã‚’æ•™ãˆã‚‹
</script>

</body>
</html>